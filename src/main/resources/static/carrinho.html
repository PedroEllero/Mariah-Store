<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrinho ‚Äî √âlan Mode</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- NAV SUPERIOR (NOVO HEADER) -->
  <div class="top-nav">
    <a href="index.html" class="nav-btn">‚Üê Voltar</a>

    <div class="nav-right">
      <a href="carrinho.html" class="nav-icon">üõí</a>
      <a href="perfil.html" class="nav-icon">üë§</a>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <h1>√âlan Mode</h1>
    <p>Seu carrinho</p>
  </header>

  <!-- MAIN -->
  <main class="main-container">

    <div id="cart-content"></div>

    <button id="finalizar-btn" class="btn-finalizar" style="display:none" onclick="finalizarCompra()">
      Finalizar Compra
    </button>

  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>&copy; 2025 √âlan Mode ‚Äî Moda com impacto social.</p>
  </footer>

  <script>
    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2200);
    }

    function formatarMoeda(v) {
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function carregarCarrinho() {
      const user = localStorage.getItem("loggedInUser");
      const cont = document.getElementById("cart-content");
      const btn = document.getElementById("finalizar-btn");

      if (!user) {
        cont.innerHTML = `<p class="empty-cart">Fa√ßa login para ver seu carrinho.</p>`;
        btn.style.display = "none";
        return;
      }

      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      if (cart.length === 0) {
        cont.innerHTML = `<p class="empty-cart">Seu carrinho est√° vazio.</p>`;
        btn.style.display = "none";
        return;
      }

      let html = `<div class="cart-items">`;
      let total = 0;

      cart.forEach((item, i) => {
        total += item.totalPrice;

        html += `
          <div class="cart-item">
            <div class="item-info">
              <h3>${item.name}</h3>
              <p class="item-meta">Tamanho: ${item.size} | Qtd: ${item.quantity}</p>
              <p>${formatarMoeda(item.unitPrice)} cada</p>
            </div>

            <p>${formatarMoeda(item.totalPrice)}</p>
            <button class="remove-btn" onclick="remover(${i})">√ó</button>
          </div>
        `;
      });

      html += `</div>`;
      html += `<div class="cart-total">Total: ${formatarMoeda(total)}</div>`;

      cont.innerHTML = html;
      btn.style.display = "block";
    }

    function remover(i) {
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      cart.splice(i, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      carregarCarrinho();
      showToast("Item removido");
    }

    async function finalizarCompra() {
      const userId = localStorage.getItem("loggedInUserId");
      if (!userId) {
        showToast("Fa√ßa login.");
        return;
      }

      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      if (cart.length === 0) {
        showToast("Carrinho vazio");
        return;
      }

      const venda = {
        clienteId: parseInt(userId),
        itens: cart.map(i => ({
          produtoId: i.id,
          quantidade: i.quantity
        }))
      };

      const resp = await fetch("http://localhost:8080/vendas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(venda)
      });

      if (!resp.ok) {
        showToast("Erro ao registrar compra");
        return;
      }

      localStorage.removeItem("cart");

      showToast("Compra finalizada!");
      setTimeout(() => window.location.href = "perfil.html#pedidos", 1200);
    }

    window.onload = carregarCarrinho;
  </script>

</body>
</html>
