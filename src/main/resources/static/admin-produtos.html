<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Produtos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="main-container">

    <h1>Gerenciar Produtos</h1>
    <a href="admin.html" class="btn-view" style="margin-bottom:20px; display:inline-block;">
      ← Voltar ao Painel
    </a>
    <div id="msg" class="msg-box" style="margin: 10px 0; display:none;"></div>
    <!-- Formulário -->
    <h2 style="margin-top:20px;">Adicionar / Editar Produto</h2>

    <form id="produtoForm">
      <input type="hidden" id="idProduto">

      <div class="input-group">
        <label>Nome</label>
        <input type="text" id="nome" required>
      </div>

      <div class="input-group">
        <label>Preço</label>
        <input type="number" id="preco" step="0.01" required>
      </div>

      <div class="input-group">
        <label>Estoque</label>
        <input type="number" id="estoque" required>
      </div>

      <div class="input-group">
        <label>Categoria</label>
        <select id="categoria" class="filter-select" required>
          <option value="">Selecione...</option>
          <option value="vestidos">Vestidos</option>
          <option value="saias">Saias</option>
          <option value="blusas">Blusas</option>
          <option value="calcas">Calças</option>
        </select>
      </div>

      <div class="input-group">
        <label>Imagem (URL)</label>
        <input type="text" id="imagem" placeholder="ex: imagens/vestido03.jpg">
      </div>

      <div class="input-group">
        <label>Descrição</label>
        <input type="text" id="descricao" maxlength="120">
      </div>

      <div class="input-group">
        <label>Fornecedor</label>
        <select id="fornecedor" required class="filter-select"></select>
      </div>

      <button type="submit" class="btn-primary">Salvar Produto</button>
    </form>

    <h2 style="margin-top:40px;">Produtos Cadastrados</h2>


    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Imagem</th>
          <th>Nome</th>
          <th>Preço</th>
          <th>Categoria</th>
          <th>Estoque</th>
          <th>Fornecedor</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaProdutos"></tbody>
    </table>

  </div>

<script>

const token = localStorage.getItem("token");
const roles = JSON.parse(localStorage.getItem("roles") || "[]");

if (!token || !roles.includes("ROLE_ADMIN")) {
  alert("Acesso negado. Apenas administradores podem acessar.");
  window.location.href = "index.html";
}

// ===================================
// URLs DA API
// ===================================
const API_PRODUTOS = "http://localhost:8080/produtos";
const API_FORNECEDORES = "http://localhost:8080/fornecedores";

// ===================================
// CARREGAR FORNECEDORES (COM TOKEN)
// ===================================
async function carregarFornecedores() {
  const resp = await fetch(API_FORNECEDORES, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!resp.ok) {
    alert("Erro ao carregar fornecedores. Acesso negado.");
    return;
  }

  const dados = await resp.json();

  const select = document.getElementById("fornecedor");
  select.innerHTML = "<option value=''>Selecione...</option>";

  dados.forEach(f => {
    select.innerHTML += `<option value="${f.idFornecedor}">${f.nome}</option>`;
  });
}

// ===================================
// LISTAR PRODUTOS (COM TOKEN)
// ===================================
async function carregarProdutos() {
  const resp = await fetch(API_PRODUTOS, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!resp.ok) {
    alert("Erro ao carregar produtos. Verifique permissões.");
    return;
  }

  const dados = await resp.json();

  const tabela = document.getElementById("tabelaProdutos");
  tabela.innerHTML = "";

  dados.forEach(p => {
    tabela.innerHTML += `
      <tr>
        <td>${p.idProduto}</td>
        <td><img src="${p.imagem}" width="60"></td>
        <td>${p.nome}</td>
        <td>${p.preco.toFixed(2)}</td>
        <td>${p.categoria}</td>
        <td>${p.estoque}</td>
        <td>${p.fornecedor.nome}</td>
        <td>
          <button class="btn-edit" onclick="editarProduto(${p.idProduto})">Editar</button>
          <button class="btn-delete" onclick="deletarProduto(${p.idProduto})">Excluir</button>
        </td>
      </tr>
    `;
  });
}

// ===================================
// EDITAR PRODUTO (COM TOKEN)
// ===================================
async function editarProduto(id) {
  const resp = await fetch(`${API_PRODUTOS}/${id}`, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!resp.ok) {
    alert("Erro ao buscar produto.");
    return;
  }

  const p = await resp.json();

  document.getElementById("idProduto").value = p.idProduto;
  document.getElementById("nome").value = p.nome;
  document.getElementById("preco").value = p.preco;
  document.getElementById("estoque").value = p.estoque;
  document.getElementById("categoria").value = p.categoria;
  document.getElementById("imagem").value = p.imagem;
  document.getElementById("descricao").value = p.descricao;
  document.getElementById("fornecedor").value = p.fornecedor.idFornecedor;

  window.scrollTo(0, 0);
}

// ===================================
// DELETAR PRODUTO (COM TOKEN)
// ===================================
async function deletarProduto(id) {
  if (!confirm("Deseja realmente excluir este produto?")) return;

  const resp = await fetch(`${API_PRODUTOS}/${id}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!resp.ok) {
    const erro = await resp.json().catch(() => null);
    mostrarMensagem(erro?.message || "Não foi possível excluir o produto.", "erro");
    return;
  }

  mostrarMensagem("Produto removido com sucesso!", "sucesso");
  carregarProdutos();
}

// ===================================
// SALVAR PRODUTO (COM TOKEN)
// ===================================
document.getElementById("produtoForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const id = document.getElementById("idProduto").value;

  const produto = {
    nome: document.getElementById("nome").value,
    preco: parseFloat(document.getElementById("preco").value),
    estoque: parseInt(document.getElementById("estoque").value),
    categoria: document.getElementById("categoria").value,
    imagem: document.getElementById("imagem").value,
    descricao: document.getElementById("descricao").value,
    fornecedor: {
      idFornecedor: parseInt(document.getElementById("fornecedor").value)
    }
  };

  const metodo = id ? "PUT" : "POST";
  const url = id ? `${API_PRODUTOS}/${id}` : API_PRODUTOS;

  const resp = await fetch(url, {
    method: metodo,
    headers: { 
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(produto)
  });

  if (!resp.ok) {
    alert("Erro ao salvar produto.");
    return;
  }

  this.reset();
  carregarProdutos();
});

// ===================================
// INICIALIZAÇÃO
// ===================================
window.onload = () => {
  carregarFornecedores();
  carregarProdutos();
}

function mostrarMensagem(texto, tipo = "erro") {
  const box = document.getElementById("msg");
  box.textContent = texto;

  box.style.display = "block";
  box.style.padding = "12px";
  box.style.borderRadius = "8px";
  box.style.fontWeight = "600";

  if (tipo === "sucesso") {
    box.style.background = "#e0ffe5";
    box.style.color = "#2d8a42";
    box.style.border = "1px solid #2d8a42";
  } else {
    box.style.background = "#ffe0e0";
    box.style.color = "#a12b2b";
    box.style.border = "1px solid #a12b2b";
  }

  setTimeout(() => {
    box.style.display = "none";
  }, 3500);
}
</script>


</body>
</html>
