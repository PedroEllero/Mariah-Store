<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Perfil — Élan Mode</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="header header-perfil">
  <a href="index.html" class="btn-voltar">← Página inicial</a>

  <h1>Élan Mode</h1>
  <p>Sua conta, seus dados, seu estilo.</p>
</header>


  <main class="main-container">
    <div class="logout-btn-container">
      <button id="logout-btn" class="logout-btn">Sair</button>
    </div>

    <div class="profile-tabs">
      <button id="tab-pedidos" class="tab-btn active">Meus Pedidos</button>
      <button id="tab-dados" class="tab-btn">Dados Pessoais</button>
    </div>

    <!-- Aba: Meus Pedidos -->
    <div id="conteudo-pedidos" class="tab-content active">
      <h2>Meus Pedidos</h2>
      <div id="lista-pedidos">
        <!-- Pedidos carregados via script -->
      </div>
    </div>

    <!-- Aba: Dados Pessoais -->
    <div id="conteudo-dados" class="tab-content">
      <h2>Dados Pessoais</h2>

      <form id="form-dados">
        <div class="input-group">
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>

        <div class="input-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" required />
        </div>

        <div class="input-group">
          <label for="telefone">Telefone</label>
          <input type="text" id="telefone" required />
        </div>

        <button type="submit" class="btn-primary">Salvar Dados</button>
        <p id="sucesso" class="sucesso" style="display:none; color:#4CAF50; margin-top:12px;">
          ✔ Dados atualizados com sucesso!
        </p>
      </form>
    </div>
  </main>

  <footer class="footer">
    <p>&copy; 2025 Élan Mode — Moda com impacto social.</p>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', async function () {

  // 1. Verifica login
  const userId = localStorage.getItem('loggedInUserId');
  if (!userId) {
    alert('Você precisa estar logado.');
    window.location.href = 'login.html';
    return;
  }

  // 2. Carregar dados reais do cliente
  async function carregarDadosCliente() {
    try {
      const response = await fetch(`http://localhost:8080/clientes/${userId}`);

      if (!response.ok) {
        alert("Erro ao buscar seus dados. Faça login novamente.");
        localStorage.clear();
        window.location.href = "login.html";
        return;
      }

      const cliente = await response.json();

      // Preenche os campos do formulário
      document.getElementById("nome").value = cliente.nome;
      document.getElementById("email").value = cliente.email;
      document.getElementById("telefone").value = cliente.telefone || "";

    } catch (e) {
      alert("Erro ao conectar ao servidor.");
      console.error(e);
    }
  }

  await carregarDadosCliente();

  // 3. Abas do perfil
  const tabPedidos = document.getElementById("tab-pedidos");
  const tabDados = document.getElementById("tab-dados");
  const conteudoPedidos = document.getElementById("conteudo-pedidos");
  const conteudoDados = document.getElementById("conteudo-dados");

  tabPedidos.onclick = () => {
    tabPedidos.classList.add("active");
    tabDados.classList.remove("active");
    conteudoPedidos.classList.add("active");
    conteudoDados.classList.remove("active");
  };

  tabDados.onclick = () => {
    tabDados.classList.add("active");
    tabPedidos.classList.remove("active");
    conteudoDados.classList.add("active");
    conteudoPedidos.classList.remove("active");
  };

  // 4. Atualizar dados (PUT /clientes/{id})
  document.getElementById("form-dados").onsubmit = async function (e) {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const email = document.getElementById("email").value.trim();
    const telefone = document.getElementById("telefone").value.trim();

    const clienteAtualizado = { nome, email, telefone };

    try {
      const response = await fetch(`http://localhost:8080/clientes/${userId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(clienteAtualizado)
      });

      if (response.ok) {
        document.getElementById("sucesso").style.display = "block";
        setTimeout(() => {
          document.getElementById("sucesso").style.display = "none";
        }, 3000);
      } else {
        alert("Erro ao salvar dados. Verifique os campos.");
      }

    } catch (error) {
      console.error(error);
      alert("Erro ao conectar com o servidor.");
    }
  };

  // 5. Logout
  document.getElementById("logout-btn").onclick = function() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInUserId");
    window.location.href = "index.html";
  };

  // 6. Pedidos (a função original permanece)
  function formatarMoeda(valor) {
    var str = valor.toFixed(2);
    var partes = str.split(".");
    var reais = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    var centavos = partes[1];
    return "R$ " + reais + "," + centavos;
  }

  async function carregarPedidos() {
    const userId = localStorage.getItem("loggedInUserId");
    const container = document.getElementById("lista-pedidos");

    if (!userId) {
        container.innerHTML = "<p>Erro: usuário não está logado.</p>";
        return;
    }

    try {
        const resp = await fetch(`http://localhost:8080/vendas/cliente/${userId}`);

        if (resp.status === 404) {
            container.innerHTML = "<p>Você ainda não realizou nenhum pedido.</p>";
            return;
        }

        if (!resp.ok) {
            container.innerHTML = "<p>Erro ao carregar pedidos.</p>";
            return;
        }

        const pedidos = await resp.json();

        if (!pedidos || pedidos.length === 0) {
            container.innerHTML = "<p>Você ainda não realizou nenhum pedido.</p>";
            return;
        }

        let html = "";

        pedidos.reverse().forEach(p => {
            html += `
                <div style="background:#f9f9f9; padding:16px; border-radius:8px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <strong>Pedido #${p.idVenda}</strong>
                        <span>${p.data}</span>
                    </div>

                    <div style="margin-bottom:12px;">
            `;

            p.itens.forEach(item => {
                html += `
                    <div style="display:flex; justify-content:space-between; font-size:0.95rem; margin-bottom:6px;">
                        <span>${item.produto} (Qtd: ${item.quantidade})</span>
                        <span>R$ ${item.subtotal.toFixed(2)}</span>
                    </div>
                `;
            });

            html += `
                    </div>

                    <div style="text-align:right; font-weight:bold; color:#e91e63;">
                        Total: R$ ${p.total.toFixed(2)}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

    } catch (e) {
        console.error(e);
        container.innerHTML = "<p>Erro ao carregar pedidos.</p>";
    }
}

  carregarPedidos();

});
</script>

</body>
</html>
